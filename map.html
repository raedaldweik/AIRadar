<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>AI Radar Globe</title>
<meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
<link href="https://api.mapbox.com/mapbox-gl-js/v3.15.0/mapbox-gl.css" rel="stylesheet">
<script src="https://api.mapbox.com/mapbox-gl-js/v3.15.0/mapbox-gl.js"></script>
<style>
  body { margin: 0; padding: 0; }
  #map { position: absolute; top: 0; bottom: 0; width: 100%; }
  #btn-spin {
      font: bold 12px/20px 'Helvetica Neue', Arial, sans-serif;
      background-color: #3386c0;
      color: #fff;
      position: absolute;
      top: 20px; left: 50%;
      z-index: 1; border: none;
      width: 200px; margin-left: -100px;
      display: block; cursor: pointer;
      padding: 10px 20px; border-radius: 3px;
  }
  #btn-spin:hover { background-color: #4ea0da; }
  .marker {
      width: 14px; height: 14px; border-radius: 50%;
      background: rgba(0,200,255,0.95);
      border: 2px solid #fff;
      box-shadow: 0 0 10px rgba(0,200,255,0.9), 0 0 20px rgba(0,200,255,0.6);
  }
  .mapboxgl-popup-content {
      background: rgba(15,23,42,0.9);
      color: #fff; border-radius: 10px; font-size: 13px;
  }
  .popup-button {
      display:block; margin-top:8px; background:#0284c7; color:#fff;
      border:none; border-radius:6px; padding:6px; cursor:pointer;
      width:100%; text-align:center;
  }
  .popup-button:hover { background:#0369a1; }
</style>
</head>
<body>
<div id="map"></div>
<button id="btn-spin">Pause rotation</button>
<script>
mapboxgl.accessToken = 'pk.eyJ1IjoicmFlZGR3ZWlrIiwiYSI6ImNtMTZqZGtpeTBta2cydnM4NjBkenhsMG8ifQ.r3ufHWJMoGh_DCH3XDhDAg';
const map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/standard-satellite',
    zoom: 1.5,
    center: [-90, 40],
    projection: 'globe'
});
map.on('style.load', () => { map.setFog({}); });

const secondsPerRevolution = 120, maxSpinZoom = 5, slowSpinZoom = 3;
let userInteracting = false, spinEnabled = true;
function spinGlobe() {
    const zoom = map.getZoom();
    if (spinEnabled && !userInteracting && zoom < maxSpinZoom) {
        let distancePerSecond = 360 / secondsPerRevolution;
        if (zoom > slowSpinZoom) {
            const zoomDif = (maxSpinZoom - zoom) / (maxSpinZoom - slowSpinZoom);
            distancePerSecond *= zoomDif;
        }
        const center = map.getCenter();
        center.lng -= distancePerSecond;
        map.easeTo({ center, duration: 1000, easing: (n) => n });
    }
}
map.on('mousedown', () => { userInteracting = true; });
map.on('mouseup', () => { userInteracting = false; spinGlobe(); });
map.on('dragend', () => { userInteracting = false; spinGlobe(); });
map.on('pitchend', () => { userInteracting = false; spinGlobe(); });
map.on('rotateend', () => { userInteracting = false; spinGlobe(); });
map.on('moveend', () => { spinGlobe(); });
document.getElementById('btn-spin').addEventListener('click', (e) => {
    spinEnabled = !spinEnabled;
    if (spinEnabled) { spinGlobe(); e.target.innerHTML = 'Pause rotation'; }
    else { map.stop(); e.target.innerHTML = 'Start rotation'; }
});
spinGlobe();

// Load and plot events
fetch("https://raedaldweik.github.io/AIRadar/map.json")
  .then(res => res.json())
  .then(events => {
    if (!Array.isArray(events)) events = events.events || [];
    events.forEach(e => {
      if (!e.lat || !e.lng) return;
      const el = document.createElement('div');
      el.className = 'marker';
      new mapboxgl.Marker(el)
        .setLngLat([e.lng, e.lat])
        .setPopup(new mapboxgl.Popup({ offset: 20 }).setHTML(`
          <div>
            <strong>${e.event}</strong><br/>
            ${e.city}, ${e.country}<br/>
            ${e.date}<br/>
            <b>Themes:</b> ${(e.themes || []).join(", ")}<br/>
            <button class="popup-button" onclick='summarizeEvent(${JSON.stringify(e)})'>Summarize with AI Assistant</button>
          </div>
        `))
        .addTo(map);
    });
  });

function summarizeEvent(eventDetails) {
  console.log("Send to AI Assistant:", eventDetails);
  // TODO: Hook this into AI assistant
}
</script>
</body>
</html>
